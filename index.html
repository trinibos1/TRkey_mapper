<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trkey Configurator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom scrollbar styling for Tailwind's custom-scrollbar class */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #3f3f46; /* zinc-700 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ef4444; /* red-500 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #dc2626; /* red-600 */
        }
        /* Allow body and root to scroll */
        html, body, #root {
            min-height: 100%; /* Ensure they take at least full height, but can grow */
            margin: 0;
            /* Removed overflow: hidden; */
        }
    </style>
</head>
<body class="font-inter">
    <div id="root"></div>

    <script type="text/babel">
        // All React component code consolidated here

        // Ensure ReactDOM is available in the current scope from the UMD bundle
        var ReactDOM = window.ReactDOM;

        // Constants with ALL shortcuts from the PDF, adapted for CircuitPython Keycode names
        const presets = {
            "BASIC": [
                { combo: "M", description: "Move" },
                { combo: "V", description: "View/Via" },
                { combo: "R", description: "Rotate/Reload" },
                { combo: "DELETE", description: "Delete/Zoom Out/Respawn" },
                { combo: "CONTROL_Z", description: "Undo" },
                { combo: "CONTROL_Y", description: "Redo" },
                { combo: "F1", description: "Help/Camera" },
                { combo: "F2", description: "Rename/Toggle Cockpit" },
                { combo: "F3", description: "Search/Chase Camera/Record" },
                { combo: "L", description: "Line/Headlights" },
                { combo: "E", description: "Extrude/Move Up/Switch Soldier" },
                { combo: "P", description: "Project/Place Component/Print" },
                { combo: "C", description: "Circle/Free Camera/Commander Cam/Crouch" },
                { combo: "Q", description: "Press/Pull/Drop Item/Roll Left/Move Down/Switch Soldier" },
                { combo: "X", description: "Cut/Look Left/Machine Gun/Lean Left" },
                { combo: "S", description: "Sketch/Throttle Down/Move Backward" },
                { combo: "T", description: "Text/Rotate/Target/Pick Weapon/Add Text" },
                { combo: "CONTROL_C", description: "Copy" },
                { combo: "CONTROL_V", description: "Paste" },
                { combo: "CONTROL_X", description: "Cut" },
                { combo: "CONTROL_S", description: "Save" },
                { combo: "CONTROL_D", description: "Duplicate" },
                { combo: "CONTROL_G", description: "Group" },
                { combo: "CONTROL_U", description: "Ungroup" },
                { combo: "CONTROL_P", description: "Publish/Command Palette/Print" },
                { combo: "CONTROL_F", description: "Find" },
                { combo: "CONTROL_H", description: "Replace/Highlight Net" },
                { combo: "CONTROL_L", description: "Lock/Align Left" },
                { combo: "CONTROL_R", description: "Align Right" },
                { combo: "CONTROL_B", description: "Rebuild Ratsnest/Break Joints/Bold" },
                { combo: "CONTROL_J", description: "Join Surfaces/Joint" },
                { combo: "CONTROL_M", description: "Material" },
                { combo: "CONTROL_K", description: "Link" },
                { combo: "CONTROL_E", description: "Align Center" },
                { combo: "ALT_DRAG", description: "Duplicate/Orbit" },
                { combo: "SHIFT_RIGHT_ARROW", description: "Nudge Right" },
                { combo: "SHIFT_SPACEBAR", description: "Cycle Units/Fire Rocket" },
                { combo: "SHIFT_DRAG", description: "Constrain" },
                { combo: "SCROLL_UP", description: "Scroll Up" },
                { combo: "SCROLL_DOWN", description: "Scroll Down" },
                { combo: "MOUSE_BUTTON_2", description: "Zoom (Mouse 2)" },
                { combo: "MOUSE_BUTTON_1", description: "Fire Guns/Click (Mouse 1)" },
                { combo: "MOUSE_BUTTON_3", description: "Track Enemy/Ping (Mouse 3)" },
                { combo: "TAB", description: "Player List/Scoreboard/Switch Input" },
                { combo: "ESCAPE", description: "Menu" },
                { combo: "ENTER", description: "Chat" },
                { combo: "BACKSPACE", description: "Leave Vehicle/Suicide" },
                { combo: "HOME", description: "Reset View" },
                { combo: "INSERT", description: "Zoom In" },
                { combo: "ALT_ENTER", description: "Fullscreen" },
                { combo: "ALT", description: "Free Look" },
                { combo: "MIDDLE_CLICK", description: "Pick Block" },
                { combo: "MOUSE_WHEEL_UP", description: "Scroll Hotbar Up" },
                { combo: "MOUSE_WHEEL_DOWN", description: "Scroll Hotbar Down" },
                { combo: "RIGHT_CLICK", description: "Aim" },
            ],
            "MEDIA": [
                { combo: "SCAN_PREVIOUS_TRACK", description: "Prev Track" },
                { combo: "SCAN_NEXT_TRACK", description: "Next Track" },
                { combo: "PLAY_PAUSE", description: "Play/Pause" },
                { combo: "MUTE", description: "Mute" },
                { combo: "VOLUME_INCREMENT", description: "Volume Up" },
                { combo: "VOLUME_DECREMENT", description: "Volume Down" },
            ],
            "MACRO": [
                { combo: "MACRO_1", description: "Macro 1" },
                { combo: "MACRO_2", description: "Macro 2" },
                { combo: "MACRO_3", description: "Macro 3" },
            ],
            "LAYERS": [
                { combo: "TG_1", description: "Toggle Layer 1" },
                { combo: "MO_1", description: "Momentary Layer 1" },
                { combo: "TO_0", description: "To Layer 0" },
            ],
            "SPECIAL": [
                { combo: "POWER", description: "Power" },
                { combo: "SLEEP", description: "Sleep" },
                { combo: "WAKE", description: "Wake" },
            ],
            "QMK LIGHTING": [
                { combo: "RGB_TOG", description: "RGB Toggle" },
                { combo: "RGB_MOD", description: "RGB Mode" },
                { combo: "RGB_HUI", description: "Hue Inc" },
                { combo: "RGB_HUD", description: "Hue Dec" },
                { combo: "RGB_SAI", description: "Sat Inc" },
                { combo: "RGB_SAD", description: "Sat Dec" },
                { combo: "RGB_VAI", description: "Val Inc" },
                { combo: "RGB_VAD", description: "Val Dec" },
            ],
            "MINECRAFT": [
                { combo: "W", description: "Move Forward" },
                { combo: "A", description: "Move Left" },
                { combo: "S", description: "Move Backward" },
                { combo: "D", description: "Move Right" },
                { combo: "SPACEBAR", description: "Jump" },
                { combo: "LEFT_SHIFT", description: "Sneak" },
                { combo: "LEFT_CONTROL", description: "Sprint" },
                { combo: "E", description: "Open Inventory" },
                { combo: "Q", description: "Drop Selected Item" },
                { combo: "T", description: "Open Chat" },
                { combo: "F3_D", description: "Clear Chat" },
                { combo: "F5", description: "Change Camera" },
                { combo: "F8", description: "Smooth Camera" },
                { combo: "DOUBLE_SPACE", description: "Fly Toggle (Creative)" },
                { combo: "CONTROL_MIDDLE_CLICK", description: "Copy Block with NBT" },
                { combo: "SHIFT_LEFT_CLICK", description: "Destroy Instantly (Creative)" },
                { combo: "SHIFT_CLICK", description: "Move Stack (Inventory)/Craft All" },
                { combo: "CONTROL_Q", description: "Drop Stack" },
                { combo: "CONTROL_CLICK", description: "Select Same Items" },
                { combo: "DOUBLE_CLICK", description: "Grab All of That Item" },
                { combo: "NUMBER_HOVER", description: "Move Item to Hotbar" },
                { combo: "F3_N", description: "Switch Gamemode" },
                { combo: "ALT_F4", description: "Rage Quit" },
                { combo: "F3_C", description: "Force Crash" },
                { combo: "F3_A", description: "Reload Chunks" },
            ],
            "WAR THUNDER": [
                { combo: "W_S", description: "Throttle Up/Down" },
                { combo: "A_D", description: "Rudder Left/Right" },
                { combo: "Q_E", description: "Roll Left/Right" },
                { combo: "LEFT_SHIFT", description: "Afterburner/Speed Boost" },
                { combo: "LEFT_CONTROL", description: "Air Brake" },
                { combo: "G", description: "Landing Gear/Grenade" },
                { combo: "F", description: "Flaps/Interact/Plant/Diffuse" },
                { combo: "V", description: "View Mode/Binocular View/Melee" },
                { combo: "C", description: "Free Camera/Commander Cam/Lean Right" },
                { combo: "X", description: "Look Left/Machine Gun/Lean Left" },
                { combo: "Z", description: "Look Right" },
                { combo: "Y", description: "Look Back/Orders" },
                { combo: "B", description: "Bomb View/Fire Mode" },
                { combo: "N", description: "Navigation Lights/Night Vision" },
                { combo: "J", description: "Bail Out" },
                { combo: "M", description: "Map" },
                { combo: "T", description: "Target/Mark Enemy" },
                { combo: "R", description: "Radar/Rangefinder/Reload" },
                { combo: "H", description: "Head Tracking/Help" },
                { combo: "SPACEBAR", description: "Fire Main Guns" },
                { combo: "LEFT_ALT", description: "Fire Secondary" },
                { combo: "CONTROL_SPACEBAR", description: "Drop Bomb" },
                { combo: "F10", description: "Save Replay" },
                { combo: "ALT_PRINT_SCREEN", description: "Screenshot" },
                { combo: "CONTROL_Y", description: "Chat Channel" },
                { combo: "CONTROL_G", description: "Gunner View" },
                { combo: "O", description: "Toggle Optics" },
                { combo: "K", description: "Thermal/IR/Kill Feed" },
                { combo: "L", description: "Headlights/Flashlight" },
                { combo: "ONE", description: "Weapon 1" },
                { combo: "TWO", description: "Weapon 2" },
                { combo: "THREE", description: "Weapon 3" },
                { combo: "U", description: "Repair/Medkit" },
            ],
            "ROBLOX STUDIO": [
                { combo: "CONTROL_S", description: "Save" },
                { combo: "CONTROL_SHIFT_S", description: "Save As" },
                { combo: "CONTROL_N", description: "New Place" },
                { combo: "CONTROL_O", description: "Open Place" },
                { combo: "CONTROL_Z", description: "Undo" },
                { combo: "CONTROL_Y", description: "Redo" },
                { combo: "CONTROL_C", description: "Copy" },
                { combo: "CONTROL_V", description: "Paste" },
                { combo: "CONTROL_X", description: "Cut" },
                { combo: "CONTROL_D", description: "Duplicate" },
                { combo: "CONTROL_G", description: "Group" },
                { combo: "CONTROL_U", description: "Ungroup" },
                { combo: "CONTROL_P", description: "Publish" },
                { combo: "F", description: "Focus Selection" },
                { combo: "SHIFT_F", description: "Follow Camera" },
                { combo: "ALT_CLICK", description: "Select Parent" },
                { combo: "CONTROL_CLICK", description: "Multi-select" },
                { combo: "CONTROL_SHIFT_H", description: "View Explorer" },
                { combo: "CONTROL_SHIFT_X", description: "Properties" },
                { combo: "CONTROL_SHIFT_C", description: "Output" },
                { combo: "CONTROL_SHIFT_D", description: "Asset Manager" },
                { combo: "CONTROL_SHIFT_E", description: "Toolbox/Export" },
                { combo: "W", description: "Camera Move Forward" },
                { combo: "A", description: "Camera Move Left" },
                { combo: "S", description: "Camera Move Backward" },
                { combo: "D", description: "Camera Move Right" },
                { combo: "E", description: "Move Up" },
                { combo: "Q", description: "Move Down" },
                { combo: "T", description: "Rotate" },
                { combo: "R", description: "Resize" },
                { combo: "G", description: "Move" },
                { combo: "CONTROL_T", description: "Anchor" },
                { combo: "CONTROL_L", description: "Lock" },
                { combo: "CONTROL_B", description: "Break Joints" },
                { combo: "CONTROL_J", description: "Join Surfaces" },
                { combo: "CONTROL_M", description: "Material" },
                { combo: "CONTROL_SHIFT_M", description: "Model" },
                { combo: "SHIFT_DRAG", description: "Constrain" },
                { combo: "ARROW_KEYS", description: "Nudge" },
                { combo: "CONTROL_P", description: "Quick Publish" },
                { combo: "ALT_SHIFT_E", description: "Export" },
                { combo: "CONTROL_ALT_T", description: "Terrain Editor" },
                { combo: "CONTROL_ONE", description: "Tool 1" },
                { combo: "CONTROL_TWO", description: "Tool 2" },
                { combo: "CONTROL_THREE", description: "Tool 3" },
                { combo: "CONTROL_FOUR", description: "Tool 4" },
                { combo: "CONTROL_SHIFT_R", description: "Run" },
                { combo: "CONTROL_SHIFT_T", description: "Test" },
                { combo: "F7", description: "Play Solo" },
                { combo: "F5", description: "Play" },
                { combo: "F6", description: "Server" },
                { combo: "F8", description: "Player" },
                { combo: "CONTROL_Q", description: "Quit" },
                { combo: "CONTROL_SHIFT_F", description: "Search All" },
            ],
            "ENLISTED": [
                { combo: "W", description: "Move Forward" },
                { combo: "A", description: "Move Left" },
                { combo: "S", description: "Move Backward" },
                { combo: "D", description: "Move Right" },
                { combo: "SPACEBAR", description: "Jump" },
                { combo: "LEFT_SHIFT", description: "Sprint" },
                { combo: "LEFT_CONTROL", description: "Crouch" },
                { combo: "Z", description: "Prone" },
                { combo: "X", description: "Lean Left" },
                { combo: "C", description: "Lean Right" },
                { combo: "F", description: "Interact" },
                { combo: "R", description: "Reload" },
                { combo: "G", description: "Grenade" },
                { combo: "T", description: "Pick Weapon" },
                { combo: "V", description: "Melee" },
                { combo: "B", description: "Fire Mode" },
                { combo: "Q_E", description: "Switch Soldier" },
                { combo: "TAB", description: "Scoreboard" },
                { combo: "M", description: "Map" },
                { combo: "N", description: "Night Vision" },
                { combo: "Y", description: "Orders" },
                { combo: "L", description: "Flashlight" },
                { combo: "ESCAPE", description: "Menu" },
                { combo: "CLICK", description: "Fire" },
                { combo: "RIGHT_CLICK", description: "Aim" },
                { combo: "SCROLL", description: "Change Weapon" },
                { combo: "ONE", description: "Weapon 1" },
                { combo: "TWO", description: "Weapon 2" },
                { combo: "THREE", description: "Weapon 3" },
                { combo: "H", description: "Help" },
                { combo: "LEFT_ALT", description: "Free Look" },
                { combo: "CONTROL_SHIFT", description: "Walk" },
                { combo: "F1", description: "Camera" },
                { combo: "ALT_M", description: "Minimap" },
                { combo: "CONTROL_R", description: "Reload Prone" },
                { combo: "CONTROL_F1", description: "Switch Class" },
                { combo: "ALT_V", description: "Change View" },
                { combo: "MIDDLE_CLICK", description: "Ping" },
                { combo: "HOLD_T", description: "Mark Enemy" },
                { combo: "HOLD_SHIFT", description: "Sprint Long" },
                { combo: "HOLD_F", description: "Plant/Diffuse" },
                { combo: "CONTROL_ONE", description: "Squad Command 1" },
                { combo: "CONTROL_TWO", description: "Squad Command 2" },
                { combo: "CONTROL_THREE", description: "Squad Command 3" },
                { combo: "CONTROL_FOUR", description: "Squad Command 4" },
                { combo: "SHIFT_ONE", description: "Formation 1" },
                { combo: "SHIFT_TWO", description: "Formation 2" },
                { combo: "SHIFT_THREE", description: "Formation 3" },
                { combo: "SHIFT_FOUR", description: "Formation 4" },
                { combo: "K", description: "Kill Feed" },
                { combo: "U", description: "Medkit" },
                { combo: "ONE", description: "Inventory" },
                { combo: "BACKSPACE", description: "Suicide" },
                { combo: "DELETE", description: "Respawn" },
                { combo: "F3", description: "Record" },
                { combo: "F12", description: "Screenshot" },
                { combo: "GRAVE_ACCENT", description: "Console" },
                { combo: "CONTROL_ALT_DELETE", description: "Force Quit" },
            ],
            "LINUX": [
                { combo: "CONTROL_ALT_T", description: "Open Terminal" },
                { combo: "LS", description: "List Directory Contents" },
                { combo: "CD", description: "Change Directory" },
                { combo: "PWD", description: "Print Working Directory" },
                { combo: "MKDIR", description: "Make Directory" },
                { combo: "RM", description: "Remove File/Directory" },
                { combo: "CP", description: "Copy File" },
                { combo: "MV", description: "Move File" },
                { combo: "SUDO", description: "Run Command as Superuser" },
                { combo: "MAN", description: "Manual Pages" },
                { combo: "TOP", description: "Show Running Processes" },
                { combo: "PS", description: "List Processes" },
                { combo: "KILL", description: "Terminate Process" },
                { combo: "GREP", description: "Search Text" },
                { combo: "CHMOD", description: "Change Permissions" },
                { combo: "CHOWN", description: "Change Ownership" },
                { combo: "NANO", description: "Text Editor" },
                { combo: "VIM", description: "Vi Improved Editor" },
                { combo: "DF", description: "Disk Usage" },
                { combo: "DU", description: "Directory Usage" },
                { combo: "TAR", description: "Archive Files" },
                { combo: "ZIP_UNZIP", description: "Compress/Extract" },
                { combo: "SSH", description: "Remote Access" },
                { combo: "SCP", description: "Secure Copy" },
                { combo: "WGET", description: "Download Files" },
                { combo: "CURL", description: "Transfer Data" },
                { combo: "ALIAS", description: "Create Shortcut Command" },
                { combo: "HISTORY", description: "Show Command History" },
                { combo: "CLEAR", description: "Clear Terminal" },
                { combo: "REBOOT", description: "Restart System" },
                { combo: "SHUTDOWN", description: "Shutdown System" },
                { combo: "UPTIME", description: "Show System Uptime" },
            ],
            "CODING IDE (VSCode Style)": [
                { combo: "CONTROL_P", description: "Quick Open File" },
                { combo: "CONTROL_SHIFT_P", description: "Command Palette" },
                { combo: "CONTROL_GRAVE_ACCENT", description: "Terminal Toggle" },
                { combo: "CONTROL_B", description: "Sidebar Toggle" },
                { combo: "CONTROL_J", description: "Panel Toggle" },
                { combo: "CONTROL_SHIFT_E", description: "Explorer" },
                { combo: "CONTROL_SHIFT_F", description: "Search in Files" },
                { combo: "CONTROL_SHIFT_G", description: "Git" },
                { combo: "CONTROL_SHIFT_D", description: "Debug" },
                { combo: "CONTROL_SHIFT_X", description: "Extensions" },
                { combo: "CONTROL_SPACEBAR", description: "Trigger Suggestion" },
                { combo: "CONTROL_FORWARD_SLASH", description: "Comment Line" },
                { combo: "ALT_UP_ARROW", description: "Move Line Up" },
                { combo: "ALT_DOWN_ARROW", description: "Move Line Down" },
                { combo: "SHIFT_ALT_DOWN_ARROW", description: "Copy Line Down" },
                { combo: "CONTROL_SHIFT_K", description: "Delete Line" },
                { combo: "CONTROL_D", description: "Select Next Occurrence" },
                { combo: "CONTROL_L", description: "Select Line" },
                { combo: "CONTROL_ENTER", description: "Insert Line Below" },
                { combo: "CONTROL_SHIFT_ENTER", description: "Insert Line Above" },
                { combo: "CONTROL_SHIFT_RIGHT_BRACKET", description: "Jump to Bracket" },
                { combo: "CONTROL_TAB", description: "Next Editor" },
                { combo: "CONTROL_SHIFT_TAB", description: "Previous Editor" },
                { combo: "CONTROL_W", description: "Close Editor" },
            ],
            "KICAD": [
                { combo: "CONTROL_N", description: "New Project" },
                { combo: "CONTROL_O", description: "Open Project" },
                { combo: "CONTROL_S", description: "Save" },
                { combo: "CONTROL_Z", description: "Undo" },
                { combo: "CONTROL_Y", description: "Redo" },
                { combo: "CONTROL_C", description: "Copy" },
                { combo: "CONTROL_V", description: "Paste" },
                { combo: "CONTROL_X", description: "Cut" },
                { combo: "DELETE", description: "Delete" },
                { combo: "R", description: "Rotate" },
                { combo: "M", description: "Move" },
                { combo: "E", description: "Edit Properties" },
                { combo: "W", description: "Wire" },
                { combo: "P", description: "Place Component" },
                { combo: "SHIFT_SPACEBAR", description: "Cycle Units" },
                { combo: "PAGE_UP", description: "Zoom In" },
                { combo: "PAGE_DOWN", description: "Zoom Out" },
                { combo: "CONTROL_SCROLL", description: "Zoom" },
                { combo: "F1", description: "Pan Direction 1" },
                { combo: "F2", description: "Pan Direction 2" },
                { combo: "F3", description: "Pan Direction 3" },
                { combo: "F4", description: "Pan Direction 4" },
                { combo: "SPACEBAR", description: "Reset Origin" },
                { combo: "ALT_ONE", description: "Layer View 1" },
                { combo: "ALT_TWO", description: "Layer View 2" },
                { combo: "ALT_THREE", description: "Layer View 3" },
                { combo: "ALT_FOUR", description: "Layer View 4" },
                { combo: "ALT_FIVE", description: "Layer View 5" },
                { combo: "CONTROL_B", description: "Rebuild Ratsnest" },
                { combo: "CONTROL_H", description: "Highlight Net" },
            ],
            "FUSION 360": [
                { combo: "S", description: "Toolbox" },
                { combo: "L", description: "Line" },
                { combo: "R", description: "Rectangle" },
                { combo: "C", description: "Circle" },
                { combo: "D", description: "Dimension" },
                { combo: "T", description: "Text" },
                { combo: "M", description: "Move" },
                { combo: "Q", description: "Press/Pull" },
                { combo: "E", description: "Extrude" },
                { combo: "F", description: "Fillet" },
                { combo: "SHIFT_S", description: "Sketch Shortcuts" },
                { combo: "CONTROL_Z", description: "Undo" },
                { combo: "CONTROL_Y", description: "Redo" },
                { combo: "CONTROL_C", description: "Copy" },
                { combo: "CONTROL_V", description: "Paste" },
                { combo: "DELETE", description: "Remove" },
                { combo: "B", description: "Emboss" },
                { combo: "J", description: "Joint" },
                { combo: "H", description: "Hole" },
                { combo: "G", description: "Grid Settings" },
                { combo: "TAB", description: "Switch Input" },
                { combo: "ALT_DRAG", description: "Orbit" },
                { combo: "SHIFT_SCROLL", description: "Pan" },
                { combo: "SCROLL", description: "Zoom" },
                { combo: "HOME", description: "View Cube" },
                { combo: "F6", description: "Home View" },
                { combo: "F7", description: "Slice" },
                { combo: "CONTROL_ONE", description: "Orthographic View 1" },
                { combo: "CONTROL_TWO", description: "Orthographic View 2" },
                { combo: "CONTROL_THREE", description: "Orthographic View 3" },
                { combo: "CONTROL_SHIFT_E", description: "Export" },
                { combo: "CONTROL_S", description: "Save" },
            ],
            "CANVA": [
                { combo: "CONTROL_C", description: "Copy" },
                { combo: "CONTROL_V", description: "Paste" },
                { combo: "CONTROL_X", description: "Cut" },
                { combo: "CONTROL_Z", description: "Undo" },
                { combo: "CONTROL_Y", description: "Redo" },
                { combo: "CONTROL_A", description: "Select All" },
                { combo: "DELETE", description: "Remove" },
                { combo: "CONTROL_G", description: "Group" },
                { combo: "CONTROL_U", description: "Ungroup" },
                { combo: "CONTROL_D", description: "Duplicate" },
                { combo: "SHIFT_ARROW", description: "Nudge" },
                { combo: "ALT_DRAG", description: "Duplicate while Dragging" },
                { combo: "T", description: "Add Text" },
                { combo: "R", description: "Add Rectangle" },
                { combo: "L", description: "Add Line" },
                { combo: "C", description: "Add Circle" },
                { combo: "B", description: "Bold" },
                { combo: "I", description: "Italic" },
                { combo: "U", description: "Underline" },
                { combo: "CONTROL_K", description: "Link" },
                { combo: "CONTROL_SHIFT_K", description: "Unlink" },
                { combo: "CONTROL_E", description: "Align Center" },
                { combo: "CONTROL_L", description: "Align Left" },
                { combo: "CONTROL_R", description: "Align Right" },
                { combo: "CONTROL_SHIFT_M", description: "Comment" },
                { combo: "ALT_LEFT_BRACKET", description: "Layer Back" },
                { combo: "ALT_RIGHT_BRACKET", description: "Layer Front" },
                { combo: "CONTROL_P", description: "Print" },
                { combo: "CONTROL_S", description: "Save" },
                { combo: "CONTROL_SHIFT_S", description: "Save As" },
                { combo: "CONTROL_SHIFT_D", description: "Download" },
            ],
        };

        const NUM_LAYERS = 4; // Increased to 4 layers for general configurator
        const initialMultiLayerGrid = Array(NUM_LAYERS).fill().map(() => Array(3).fill().map(() => Array(3).fill({ tap: null, hold: null })));

        // Helper function to get a short label from a description
        const getShortLabel = (description) => {
            if (!description) return "";
            const parts = description.split('/');
            if (parts[0]) {
                const firstWord = parts[0].trim().split(' ')[0];
                return firstWord.length > 0 ? firstWord : description;
            }
            return description;
        };


        // Modal component
        const Modal = ({ show, title, message, onClose }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-zinc-800 text-white p-6 rounded-lg shadow-xl max-w-sm w-full border-2 border-red-500">
                        <h3 className="text-xl font-bold mb-4 text-red-400">{title}</h3>
                        {message && <p className="mb-4">{message}</p>}
                        <div className="flex justify-end">
                            <button
                                onClick={onClose}
                                className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-xl shadow-lg transition-colors duration-200"
                            >
                                OK
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Confirmation Modal
        const ConfirmationModal = ({ show, title, message, onConfirm, onCancel }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-zinc-800 text-white p-6 rounded-lg shadow-xl max-w-sm w-full border-2 border-red-500">
                        <h3 className="text-xl font-bold mb-4 text-red-400">{title}</h3>
                        {message && <p className="mb-4">{message}</p>}
                        <div className="flex justify-end space-x-4">
                            <button
                                onClick={onCancel}
                                className="bg-zinc-600 hover:bg-zinc-700 px-4 py-2 rounded-xl shadow-lg transition-colors duration-200"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={onConfirm}
                                className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-xl shadow-lg transition-colors duration-200"
                            >
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Sidebar component
        const Sidebar = ({ activeTab, setActiveTab }) => {
            const { useState, useEffect } = React;
            return (
                <div className="w-64 bg-zinc-900 p-6 flex flex-col border-r border-zinc-700 shadow-xl">
                    <div className="text-2xl font-bold text-red-500 mb-8">Trkey</div>
                    <nav className="flex-grow">
                        <ul className="space-y-4">
                            <li>
                                <a href="#" onClick={() => setActiveTab('keymap')} className={`flex items-center ${activeTab === 'keymap' ? 'text-red-300' : 'text-zinc-400'} hover:text-red-500 font-semibold text-lg transition-colors duration-200`}>
                                    <svg className="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                                    KEYMAP
                                </a>
                            </li>
                            <li>
                                <a href="#" onClick={() => setActiveTab('macros')} className={`flex items-center ${activeTab === 'macros' ? 'text-red-300' : 'text-zinc-400'} hover:text-white transition-colors duration-200`}>
                                    <svg className="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M12 6.293V4a1 1 0 00-1-1H5a1 1 0 00-1 1v10a1 1 0 001 1h6a1 1 0 001-1v-2.293l1.707 1.707a1 1 0 001.414-1.414l-4-4a1 1 0 00-1.414 0l-4 4a1 1 0 001.414 1.414L10 10.414V12a1 1 0 001 1h2a1 1 0 001-1V8.293l1.707 1.707a1 1 0 001.414-1.414l-4-4z"></path></svg>
                                    MACROS
                                </a>
                            </li>
                            <li>
                                <a href="#" onClick={() => setActiveTab('controls')} className={`flex items-center ${activeTab === 'controls' ? 'text-red-300' : 'text-zinc-400'} hover:text-white transition-colors duration-200`}>
                                    <svg className="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm6-1a1 1 0 100-2 1 1 0 000 2zm-3 8a1 1 0 100-2 1 1 0 000 2z"></path></svg>
                                    CONTROLS
                                </a>
                            </li>
                            <li>
                                <a href="#" onClick={() => setActiveTab('save-load')} className={`flex items-center ${activeTab === 'save-load' ? 'text-red-300' : 'text-zinc-400'} hover:text-white transition-colors duration-200`}>
                                    <svg className="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a2 1 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path></svg>
                                    SAVE + LOAD
                                </a>
                            </li>
                            <li>
                                <a href="#" onClick={() => setActiveTab('settings')} className={`flex items-center ${activeTab === 'settings' ? 'text-red-300' : 'text-zinc-400'} hover:text-white transition-colors duration-200`}>
                                    <svg className="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zm4 4a1 1 0 011 1v1a1 1 0 01-2 0V7a1 1 0 011-1zM6 6a1 1 0 00-1 1v1a1 1 0 002 0V7a1 1 0 00-1-1zm0 8a1 1 0 00-1 1v1a1 1 0 002 0v-1a1 1 0 00-1-1zm8 0a1 1 0 00-1 1v1a1 1 0 002 0v-1a1 1 0 00-1-1zm-4 4a1 1 0 00-1 1v1a1 1 0 002 0v-1a1 1 0 00-1-1zM2 10a1 1 0 001 1h1a1 1 0 000-2H3a1 1 0 00-1 1zm14 0a1 1 0 001 1h1a1 1 0 000-2h-1a1 1 0 00-1 1zM7 10a3 3 0 116 0 3 3 0 01-6 0z"></path></svg>
                                    SETTINGS
                                </a>
                            </li>
                            <li>
                                <a href="#" onClick={() => setActiveTab('keytester')} className={`flex items-center ${activeTab === 'keytester' ? 'text-red-300' : 'text-zinc-400'} hover:text-white transition-colors duration-200`}>
                                    <svg className="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 002 0V3zM14 8a1 1 0 011 1v1a1 1 0 11-2 0V9a1 1 0 011-1zM6 8a1 1 0 00-1 1v1a1 1 0 002 0V9a1 1 0 00-1-1zm0 4a1 1 0 00-1 1v1a1 1 0 002 0v-1a1 1 0 00-1-1zm8 0a1 1 0 00-1 1v1a1 1 0 002 0v-1a1 1 0 00-1-1zm-4 4a1 1 0 00-1 1v1a1 1 0 002 0v-1a1 1 0 00-1-1zM2 10a1 1 0 001 1h1a1 1 0 000-2H3a1 1 0 00-1 1zm14 0a1 1 0 001 1h1a1 1 0 000-2h-1a1 1 0 00-1 1zM7 10a3 3 0 116 0 3 3 0 01-6 0z"></path></svg>
                                    KEY TESTER
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            );
        };

        // KeymapGrid component
        const KeymapGrid = ({ keymap, handleDrop, handleKeymapDragStart, handleDragEnd, clearKeymapCell, currentLayer, setCurrentLayer, selectedKeymapCell, handleKeymapCellClick }) => {
            const { useState, useEffect } = React;
            return (
                <div className="flex flex-col items-center">
                    <div className="flex space-x-2 mb-4">
                        {[...Array(NUM_LAYERS)].map((_, index) => (
                            <button
                                key={`layer-btn-${index}`}
                                onClick={() => setCurrentLayer(index)}
                                className={`px-4 py-2 rounded-lg font-semibold transition-colors duration-200
                                            ${currentLayer === index ? 'bg-red-600 text-white shadow-md' : 'bg-zinc-700 text-zinc-300 hover:bg-zinc-600'}`}
                            >
                                Layer {index}
                            </button>
                        ))}
                    </div>
                    <div className="grid grid-cols-3 gap-4 mb-12 w-full max-w-md mx-auto">
                        {keymap[currentLayer].map((row, rIdx) => (
                            row.map((cell, cIdx) => (
                                <div
                                    key={`${rIdx}-${cIdx}`}
                                    className={`relative bg-zinc-700 rounded-xl p-4 h-32 flex flex-col items-center justify-center border-2 border-zinc-600 shadow-md
                                                hover:border-red-500 transition-all duration-200 cursor-grab
                                                ${selectedKeymapCell && selectedKeymapCell.row === rIdx && selectedKeymapCell.col === cIdx && selectedKeymapCell.layer === currentLayer ? 'border-blue-500 ring-2 ring-blue-500' : ''}`}
                                    onDragOver={(e) => e.preventDefault()}
                                    onDrop={(e) => handleDrop(e, rIdx, cIdx)}
                                    draggable
                                    onDragStart={(e) => handleKeymapDragStart(e, cell, rIdx, cIdx)}
                                    onDragEnd={handleDragEnd}
                                    onClick={() => handleKeymapCellClick(rIdx, cIdx, currentLayer)}
                                >
                                    {cell.tap ? (
                                        <>
                                            <span className="text-2xl font-bold text-red-300">{cell.tap.combo}</span>
                                            <span className="text-sm text-zinc-400 text-center mt-1">{cell.tap.description}</span>
                                        </>
                                    ) : (
                                        <span className="text-zinc-500">Drag & Drop Here</span>
                                    )}
                                    {(cell.tap || cell.hold) && (
                                        <button
                                            onClick={(e) => { e.stopPropagation(); clearKeymapCell(rIdx, cIdx); }}
                                            className="absolute top-1 right-1 text-zinc-400 hover:text-red-500 text-sm p-1 rounded-full bg-zinc-600 hover:bg-zinc-500 transition-colors"
                                            title="Clear cell"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    )}
                                </div>
                            ))
                        ))}
                    </div>
                </div>
            );
        };

        // ShortcutPool component
        const ShortcutPool = ({ shortcutPool, draggedShortcut, handleShortcutDragStart, handleDragEnd, selectedKeymapCell, handleShortcutClick }) => {
            const { useState, useEffect, useMemo } = React;
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedCategory, setSelectedCategory] = useState(Object.keys(shortcutPool)[0]);

            const filteredShortcuts = useMemo(() => {
                if (!selectedCategory) return [];

                const categoryShortcuts = shortcutPool[selectedCategory] || [];
                if (!searchTerm) return categoryShortcuts;

                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                return categoryShortcuts.filter(shortcut =>
                    shortcut.combo.toLowerCase().includes(lowerCaseSearchTerm) ||
                    shortcut.description.toLowerCase().includes(lowerCaseSearchTerm)
                );
            }, [searchTerm, selectedCategory, shortcutPool]);

            return (
                <div className="flex flex-col md:flex-row w-full bg-zinc-800 rounded-xl shadow-lg border border-zinc-700 overflow-hidden">
                    {/* Left Sidebar for Categories */}
                    <div className="w-full md:w-1/4 bg-zinc-900 p-4 custom-scrollbar overflow-y-auto border-r border-zinc-700">
                        <h3 className="text-xl font-semibold text-red-300 mb-4">Categories</h3>
                        <ul className="space-y-2">
                            {Object.keys(shortcutPool).map(category => (
                                <li key={category}>
                                    <button
                                        onClick={() => setSelectedCategory(category)}
                                        className={`w-full text-left px-4 py-2 rounded-lg transition-colors duration-200
                                                    ${selectedCategory === category ? 'bg-red-600 text-white font-bold' : 'bg-zinc-700 text-zinc-300 hover:bg-zinc-600'}`}
                                    >
                                        {category}
                                    </button>
                                </li>
                            ))}
                        </ul>
                    </div>

                    {/* Right Main Content Area for Search and Shortcuts */}
                    <div className="flex-1 flex flex-col p-4">
                        {/* Search Bar */}
                        <div className="relative w-full mb-6">
                            <input
                                type="text"
                                placeholder="Search shortcuts..."
                                className="w-full p-3 pl-10 rounded-xl bg-zinc-700 text-white border border-zinc-600 focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all duration-200"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                            <svg className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-zinc-400" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd"></path></svg>
                        </div>

                        {/* Shortcuts Grid */}
                        <div className="flex-1 grid grid-cols-2 md:grid-cols-3 gap-4 custom-scrollbar overflow-y-auto pr-2">
                            {filteredShortcuts.length > 0 ? (
                                filteredShortcuts.map((shortcut, sIdx) => (
                                    <div
                                        key={`${selectedCategory}-${sIdx}`}
                                        className={`bg-zinc-600 rounded-lg p-3 flex flex-col items-center justify-center cursor-pointer text-center
                                                    ${draggedShortcut === shortcut ? 'opacity-50 border-red-500 border-2' : 'border-2 border-zinc-600'}
                                                    ${selectedKeymapCell ? 'hover:bg-blue-700 hover:border-blue-400' : 'hover:bg-zinc-500 hover:border-red-400'}
                                                    transition-all duration-200`}
                                        draggable
                                        onDragStart={(e) => handleShortcutDragStart(e, shortcut)}
                                        onDragEnd={handleDragEnd}
                                        onClick={() => handleShortcutClick(shortcut)}
                                    >
                                        <span className="font-medium text-lg">{shortcut.combo}</span>
                                        <span className="text-sm text-zinc-300">{shortcut.description}</span>
                                    </div>
                                ))
                            ) : (
                                <p className="text-zinc-400 text-lg col-span-full text-center">No shortcuts found in "{selectedCategory}" matching "{searchTerm}".</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // MacroManagement component
        const MacroManagement = ({ macros, addMacro, editMacro, deleteMacro }) => {
            const { useState, useEffect } = React;
            return (
                <div className="flex flex-col items-center w-full">
                    <h1 className="text-4xl font-extrabold text-red-400 mb-8">MACRO MANAGEMENT</h1>
                    <button
                        onClick={addMacro}
                        className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-xl shadow-lg transition-colors duration-200 text-lg font-semibold mb-8"
                    >
                        Add New Macro
                    </button>

                    {macros.length === 0 ? (
                        <p className="text-zinc-400 text-lg">No macros defined yet. Click "Add New Macro" to create one.</p>
                    ) : (
                        <div className="w-full max-w-2xl bg-zinc-700 rounded-xl p-6 shadow-lg border-2 border-zinc-600">
                            <h2 className="text-2xl font-bold text-red-300 mb-4">Defined Macros</h2>
                            <ul className="space-y-4">
                                {macros.map(macro => (
                                    <li key={macro.id} className="bg-zinc-600 rounded-lg p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-md border border-zinc-500">
                                        <div>
                                            <p className="text-xl font-semibold text-white">{macro.name}</p>
                                            <p className="text-zinc-300 text-sm break-all">Sequence: "{macro.sequence}"</p>
                                        </div>
                                        <div className="flex space-x-3 mt-3 sm:mt-0">
                                            <button
                                                onClick={() => editMacro(macro.id)}
                                                className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm transition-colors duration-200"
                                            >
                                                Edit
                                            </button>
                                            <button
                                                onClick={() => deleteMacro(macro.id)}
                                                className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm transition-colors duration-200"
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>
            );
        };

        // PeripheralControls component
        const PeripheralControls = ({ potentiometerConfig, setPotentiometerConfig }) => {
            return (
                <div className="flex flex-col items-center w-full">
                    <h1 className="text-4xl font-extrabold text-red-400 mb-8">PERIPHERAL CONTROLS</h1>

                    <div className="w-full max-w-2xl bg-zinc-700 rounded-xl p-6 shadow-lg border-2 border-zinc-600 mb-8">
                        <h2 className="text-2xl font-bold text-red-300 mb-4">Potentiometer Settings</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="flex items-center">
                                <label htmlFor="pot-enable" className="text-zinc-300 mr-3">Enable Potentiometer:</label>
                                <input
                                    type="checkbox"
                                    id="pot-enable"
                                    className="form-checkbox h-5 w-5 text-red-600 rounded-md focus:ring-red-500 bg-zinc-600 border-zinc-500"
                                    checked={potentiometerConfig.enabled}
                                    onChange={(e) => setPotentiometerConfig(prev => ({ ...prev, enabled: e.target.checked }))}
                                />
                            </div>
                            <div>
                                <label htmlFor="pot-pin" className="block text-zinc-300 text-sm font-semibold mb-2">Analog Pin:</label>
                                <input
                                    type="number"
                                    id="pot-pin"
                                    className="w-full p-2 rounded-md bg-zinc-800 text-white border border-zinc-600 focus:border-red-500"
                                    value={potentiometerConfig.pin}
                                    onChange={(e) => setPotentiometerConfig(prev => ({ ...prev, pin: parseInt(e.target.value) || 0 }))}
                                    disabled={!potentiometerConfig.enabled}
                                />
                            </div>
                            <div>
                                <label htmlFor="pot-function" className="block text-zinc-300 text-sm font-semibold mb-2">Function:</label>
                                <select
                                    id="pot-function"
                                    className="w-full p-2 rounded-md bg-zinc-800 text-white border border-zinc-600 focus:border-red-500"
                                    value={potentiometerConfig.function}
                                    onChange={(e) => setPotentiometerConfig(prev => ({ ...prev, function: e.target.value }))}
                                    disabled={!potentiometerConfig.enabled}
                                >
                                    <option value="volume">Volume Control</option>
                                    <option value="brightness">Brightness Control</option>
                                    <option value="scroll">Scroll</option>
                                    <option value="custom">Custom Action (Macro/Keycode)</option>
                                </select>
                            </div>
                            {potentiometerConfig.function === 'custom' && (
                                <div>
                                    <label htmlFor="pot-custom-action" className="block text-zinc-300 text-sm font-semibold mb-2">Custom Action (Keycode/Macro Name):</label>
                                    <input
                                        type="text"
                                        id="pot-custom-action"
                                        className="w-full p-2 rounded-md bg-zinc-800 text-white border border-zinc-600 focus:border-red-500"
                                        value={potentiometerConfig.customAction}
                                        onChange={(e) => setPotentiometerConfig(prev => ({ ...prev, customAction: e.target.value }))}
                                    />
                                </div>
                            )}
                        </div>
                        <p className="text-zinc-400 text-sm mt-4">
                            Note: Potentiometer functionality requires specific firmware support on your microcontroller. This configuration only sets preferences.
                        </p>
                    </div>
                </div>
            );
        };

        // SaveLoad component - Integrated with USB File Server client logic
        const SaveLoad = ({ saveProfile, loadProfile, exportKeymap, getFullConfig }) => {
            const { useState, useEffect, useRef } = React;

            const [webSerialStatus, setWebSerialStatus] = useState('Disconnected'); // 'Disconnected', 'Connecting', 'Connected', 'Error'
            const [serialPort, setSerialPort] = useState(null);
            const serialWriter = useRef(null);
            const serialReader = useRef(null);
            const serialOutputRef = useRef(null); // Ref for the textarea output

            // Function to append text to the serial output textarea
            const appendOutput = (text) => {
                if (serialOutputRef.current) {
                    serialOutputRef.current.value += text;
                    serialOutputRef.current.scrollTop = serialOutputRef.current.scrollHeight;
                }
            };

            // Read loop for incoming serial data
            const readLoop = async () => {
                if (!serialReader.current || !serialPort) return;
                try {
                    while (serialPort.readable) {
                        const { value, done } = await serialReader.current.read();
                        if (done) break;
                        if (value) appendOutput(new TextDecoder().decode(value));
                    }
                } catch (error) {
                    console.error("Serial read error:", error);
                    appendOutput(`\nError reading from serial: ${error.message}\n`);
                    setWebSerialStatus('Error');
                } finally {
                    if (serialReader.current) {
                        serialReader.current.releaseLock();
                        serialReader.current = null;
                    }
                }
            };

            // Connect Web Serial
            const connectWebSerial = async () => {
                if (!('serial' in navigator)) {
                    alert("Web Serial API not supported in your browser. Please use Chrome, Edge, or Opera.");
                    setWebSerialStatus('Error');
                    return;
                }

                setWebSerialStatus('Connecting');
                appendOutput("Connecting...\n");
                try {
                    const port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });

                    serialWriter.current = port.writable.getWriter();
                    serialReader.current = port.readable.getReader();

                    setSerialPort(port); // Set the port in state once successfully opened
                    setWebSerialStatus('Connected');
                    appendOutput("Connected!\n");
                    readLoop(); // Start reading data
                } catch (err) {
                    setWebSerialStatus('Error');
                    appendOutput(`Failed to connect: ${err.message}\n`);
                    console.error("Web Serial Connect Error:", err);
                }
            };

            // Disconnect Web Serial
            const disconnectWebSerial = async () => {
                if (serialWriter.current) {
                    await serialWriter.current.releaseLock();
                    serialWriter.current = null;
                }
                if (serialReader.current) {
                    // This might cause the readLoop to break, which is intended for disconnect
                    await serialReader.current.cancel();
                    serialReader.current = null;
                }
                if (serialPort) {
                    try {
                        await serialPort.close();
                    } catch (err) {
                        console.error("Error closing serial port:", err);
                        appendOutput(`Error closing port: ${err.message}\n`);
                    } finally {
                        setSerialPort(null);
                    }
                }
                setWebSerialStatus('Disconnected');
                appendOutput("Disconnected.\n");
            };

            // Send command over serial
            const sendCommand = async (cmd) => {
                if (!serialWriter.current) {
                    appendOutput("Not connected to a serial port.\n");
                    return;
                }
                try {
                    await serialWriter.current.write(new TextEncoder().encode(cmd + "\n"));
                } catch (error) {
                    console.error("Error sending command:", error);
                    appendOutput(`Error sending command: ${error.message}\n`);
                    setWebSerialStatus('Error');
                }
            };

            // Upload configuration file using PUT command
            const uploadToDevice = async () => {
                if (webSerialStatus !== 'Connected') {
                    alert("Please connect to a serial port first!");
                    return;
                }

                appendOutput("\nInitiating file upload...\n");
                const configData = getFullConfig(); // Get the full config from App component
                const jsonContent = JSON.stringify(configData, null, 2);
                const filename = "config.json"; // Hardcode filename for Trkey config

                try {
                    await sendCommand("PUT " + filename);

                    // Wait for READY signal from the device
                    // In a real scenario, you'd parse incoming data for "READY"
                    // For now, a short delay to allow device to process PUT command
                    await new Promise(r => setTimeout(r, 500)); // Increased timeout

                    const encoder = new TextEncoder();
                    const bytes = encoder.encode(jsonContent);

                    // Send the file content in chunks if necessary, or all at once
                    await serialWriter.current.write(bytes);
                    appendOutput(`Sent ${bytes.length} bytes for ${filename}\n`);

                    await serialWriter.current.write(encoder.encode("<EOF>\n")); // Send EOF marker
                    appendOutput("File transfer complete. Sent <EOF>.\n");
                    appendOutput("Device should now process the file. You may need to reset your device.\n");

                } catch (err) {
                    appendOutput(`Error during file upload: ${err.message}\n`);
                    console.error("File upload error:", err);
                    setWebSerialStatus('Error');
                }
            };

            // Clean up serial connection on unmount
            useEffect(() => {
                return () => {
                    disconnectWebSerial();
                };
            }, []); // Empty dependency array means this runs once on mount and once on unmount

            return (
                <div className="flex flex-col items-center w-full">
                    <h1 className="text-4xl font-extrabold text-red-400 mb-8">SAVE & LOAD PROFILE</h1>
                    <div className="w-full max-w-md bg-zinc-700 rounded-xl p-6 shadow-lg border-2 border-zinc-600 mb-8">
                        <h2 className="text-2xl font-bold text-red-300 mb-4">Local Profile Management</h2>
                        <div className="flex flex-col space-y-4">
                            <button
                                onClick={saveProfile}
                                className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-xl shadow-lg transition-colors duration-200 text-lg font-semibold"
                            >
                                Save Profile to Browser
                            </button>
                            <button
                                onClick={loadProfile}
                                className="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-xl shadow-lg transition-colors duration-200 text-lg font-semibold"
                            >
                                Load Profile from Browser
                            </button>
                        </div>
                    </div>

                    <div className="w-full max-w-md bg-zinc-700 rounded-xl p-6 shadow-lg border-2 border-zinc-600 mb-8">
                        <h2 className="text-2xl font-bold text-red-300 mb-4">Device Interaction (Web Serial)</h2>
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center">
                                <span className={`h-3 w-3 rounded-full mr-2 ${webSerialStatus === 'Connected' ? 'bg-green-500' : webSerialStatus === 'Connecting' ? 'bg-yellow-500 animate-pulse' : 'bg-red-500'}`}></span>
                                <span className="text-sm font-semibold text-zinc-300">Status: {webSerialStatus}</span>
                            </div>
                            <div className="flex space-x-2">
                                {webSerialStatus === 'Disconnected' && (
                                    <button
                                        onClick={connectWebSerial}
                                        className="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-xl shadow-lg transition-colors duration-200 text-sm font-semibold"
                                    >
                                        Connect
                                    </button>
                                )}
                                {webSerialStatus === 'Connected' && (
                                    <button
                                        onClick={disconnectWebSerial}
                                        className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-xl shadow-lg transition-colors duration-200 text-sm font-semibold"
                                    >
                                        Disconnect
                                    </button>
                                )}
                            </div>
                        </div>
                        <div className="flex flex-col space-y-4">
                            <button
                                onClick={exportKeymap}
                                className="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-xl shadow-lg transition-colors duration-200 text-lg font-semibold"
                            >
                                Export Configuration as config.json
                            </button>
                            <button
                                onClick={uploadToDevice}
                                className={`px-6 py-3 rounded-xl shadow-lg transition-colors duration-200 text-lg font-semibold
                                            ${webSerialStatus === 'Connected' ? 'bg-teal-600 hover:bg-teal-700' : 'bg-zinc-600 cursor-not-allowed'}`}
                                disabled={webSerialStatus !== 'Connected'}
                            >
                                Upload to Device (Web Serial)
                            </button>
                            <p className="text-zinc-400 text-sm mt-2">
                                For **Web Serial Upload**: Your device must be running a compatible USB File Server firmware. The `config.json` file will be sent via serial.
                            </p>
                        </div>
                    </div>

                    <div className="w-full max-w-2xl bg-zinc-700 rounded-xl p-6 shadow-lg border-2 border-zinc-600">
                        <h2 className="text-2xl font-bold text-red-300 mb-4">Serial Output</h2>
                        <textarea
                            ref={serialOutputRef}
                            className="w-full h-48 bg-zinc-800 border border-zinc-600 rounded-md p-4 text-white font-mono text-sm resize-y custom-scrollbar"
                            readOnly
                            placeholder="Serial communication log will appear here..."
                        ></textarea>
                    </div>
                </div>
            );
        };


        // Settings component
        const Settings = ({ jsonInput, setJsonInput, loadJsonFromTextArea }) => {
            const { useState, useEffect } = React;
            return (
                <div className="flex flex-col items-center w-full">
                    <h1 className="text-4xl font-extrabold text-red-400 mb-8">SETTINGS</h1>
                    <div className="w-full max-w-2xl bg-zinc-700 rounded-xl p-6 shadow-lg border-2 border-zinc-600">
                        <h2 className="text-2xl font-bold text-red-300 mb-4">Import JSON Configuration</h2>
                        <textarea
                            className="w-full h-64 bg-zinc-800 border border-zinc-600 rounded-md p-4 text-white font-mono text-sm resize-y custom-scrollbar"
                            placeholder="Paste your config.json here..."
                            value={jsonInput}
                            onChange={(e) => setJsonInput(e.target.value)}
                        ></textarea>
                        <button
                            onClick={loadJsonFromTextArea}
                            className="mt-4 bg-teal-600 hover:bg-teal-700 px-6 py-3 rounded-xl shadow-lg transition-colors duration-200 text-lg font-semibold w-full"
                        >
                            Load JSON
                        </button>
                    </div>
                </div>
            );
        };

        // KeyTester component
        const KeyTester = ({ activeTab }) => {
            const { useState, useEffect } = React;
            const [pressedKeys, setPressedKeys] = useState([]);

            useEffect(() => {
                if (activeTab === 'keytester') {
                    const handleKeyDown = (e) => {
                        e.preventDefault();
                        setPressedKeys(prev => {
                            const newKey = { key: e.key, code: e.code, timestamp: Date.now() };
                            if (!prev.some(k => k.code === e.code && k.type === 'down')) {
                                return [...prev, { ...newKey, type: 'down' }];
                            }
                            return prev;
                        });
                    };

                    const handleKeyUp = (e) => {
                        e.preventDefault();
                        setPressedKeys(prev => prev.filter(k => k.code !== e.code));
                    };

                    window.addEventListener('keydown', handleKeyDown);
                    window.addEventListener('keyup', handleKeyUp);

                    return () => {
                        window.removeEventListener('keydown', handleKeyDown);
                        window.removeEventListener('keyup', handleKeyUp);
                    };
                } else {
                    setPressedKeys([]);
                }
            }, [activeTab]);

            return (
                <div className="flex flex-col items-center w-full">
                    <h1 className="text-4xl font-extrabold text-red-400 mb-8">KEY TESTER</h1>
                    <p className="text-zinc-300 mb-6 text-lg">Press any key on your keyboard to see its details.</p>
                    <div className="w-full max-w-2xl bg-zinc-700 rounded-xl p-6 shadow-lg border-2 border-zinc-600 min-h-[200px] flex flex-wrap items-center justify-center gap-4">
                        {pressedKeys.length === 0 ? (
                            <p className="text-zinc-400 text-xl">No keys pressed...</p>
                        ) : (
                            pressedKeys.map((keyInfo, index) => (
                                <div
                                    key={keyInfo.code + '-' + keyInfo.timestamp}
                                    className="bg-zinc-600 rounded-lg p-4 shadow-md border border-zinc-500 flex flex-col items-center justify-center min-w-[120px]"
                                >
                                    <span className="text-xl font-bold text-red-300">{keyInfo.key === ' ' ? 'Space' : keyInfo.key}</span>
                                    <span className="text-sm text-zinc-400 mt-1">{keyInfo.code}</span>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };


        // Main App component
        function App() {
            const { useState, useEffect, useCallback } = React;

            const [keymap, setKeymap] = useState(initialMultiLayerGrid);
            const [shortcutPool, setShortcutPool] = useState(Object.fromEntries(Object.entries(presets).map(([k, v]) => [k, [...v]])));
            const [showModal, setShowModal] = useState(false);
            const [modalContent, setModalContent] = useState({ title: "", message: "" });
            const [draggedShortcut, setDraggedShortcut] = useState(null);
            const [activeTab, setActiveTab] = useState('keymap');
            const [jsonInput, setJsonInput] = useState('');
            const [currentLayer, setCurrentLayer] = useState(0);
            const [selectedKeymapCell, setSelectedKeymapCell] = useState(null);

            const [macros, setMacros] = useState([
                { id: 1, name: "Hello World", sequence: "Hello World!" },
                { id: 2, name: "Signature", sequence: "John Doe\nSoftware Engineer" },
            ]);
            const [nextMacroId, setNextMacroId] = useState(3);

            const [potentiometerConfig, setPotentiometerConfig] = useState({
                enabled: false,
                pin: 26, // Default analog pin for RP2040 (GP26 is ADC0)
                function: 'volume', // 'volume', 'brightness', 'scroll', 'custom'
                customAction: '' // For custom function, e.g., a keycode or macro name
            });


            // Load profile on component mount
            useEffect(() => {
                loadProfile();
            }, []);

            // Handlers for drag and drop
            const handleDrop = (e, row, col) => {
                e.preventDefault();
                const data = e.dataTransfer.getData("text/plain");
                let droppedItem;

                try {
                    droppedItem = JSON.parse(data);
                } catch (error) {
                    console.error("Failed to parse dropped data:", error);
                    setDraggedShortcut(null);
                    return;
                }

                const newKeymap = JSON.parse(JSON.stringify(keymap));

                if (droppedItem.isKeymapCell) {
                    const sourceRow = droppedItem.sourceRow;
                    const sourceCol = droppedItem.sourceCol;
                    const sourceLayer = droppedItem.sourceLayer;

                    if (sourceLayer === currentLayer) {
                        const tempCell = newKeymap[currentLayer][row][col];
                        newKeymap[currentLayer][row][col] = newKeymap[currentLayer][sourceRow][sourceCol];
                        newKeymap[currentLayer][sourceRow][sourceCol] = tempCell;
                    } else {
                        newKeymap[currentLayer][row][col] = droppedItem.cell;
                    }
                } else {
                    newKeymap[currentLayer][row][col] = { tap: droppedItem, hold: null };
                }

                setKeymap(newKeymap);
                setDraggedShortcut(null);
                setSelectedKeymapCell(null);
            };


            const handleKeymapDragStart = (e, cell, row, col) => {
                const dragData = JSON.stringify({ isKeymapCell: true, cell: cell, sourceRow: row, sourceCol: col, sourceLayer: currentLayer });
                e.dataTransfer.setData("text/plain", dragData);
                setSelectedKeymapCell(null);
            };

            const handleShortcutDragStart = (e, shortcut) => {
                e.dataTransfer.setData("text/plain", JSON.stringify(shortcut));
                setDraggedShortcut(shortcut);
                setSelectedKeymapCell(null);
            };

            const handleDragEnd = () => {
                setDraggedShortcut(null);
            };

            const clearKeymapCell = (rIdx, cIdx) => {
                const updatedKeymap = keymap.map((layer, lIdx) =>
                    lIdx === currentLayer
                        ? layer.map((r, rowIdx) =>
                              r.map((cell, colIdx) =>
                                  (rowIdx === rIdx && colIdx === cIdx) ? { tap: null, hold: null } : cell
                              )
                          )
                        : layer
                );
                setKeymap(updatedKeymap);
                setSelectedKeymapCell(null);
            };

            const handleKeymapCellClick = (row, col, layer) => {
                if (selectedKeymapCell && selectedKeymapCell.row === row && selectedKeymapCell.col === col && selectedKeymapCell.layer === layer) {
                    setSelectedKeymapCell(null);
                } else {
                    setSelectedKeymapCell({ row, col, layer });
                }
            };

            const handleShortcutClick = (shortcut) => {
                if (selectedKeymapCell) {
                    const { row, col, layer } = selectedKeymapCell;
                    const newKeymap = JSON.parse(JSON.stringify(keymap));
                    newKeymap[layer][row][col] = { tap: shortcut, hold: null };
                    setKeymap(newKeymap);
                    setSelectedKeymapCell(null);
                } else {
                    setModalContent({
                        title: "No Keymap Cell Selected",
                        message: "Please click a keymap cell first to select it, then click a shortcut to assign it."
                    });
                    setShowModal(true);
                }
            };


            // Profile Management
            const saveProfile = () => {
                const profileData = {
                    keymap: keymap,
                    potentiometerConfig: potentiometerConfig,
                    macros: macros
                };
                localStorage.setItem("trkey_profile", JSON.stringify(profileData)); // Generic key
                setModalContent({
                    title: "Profile Saved",
                    message: "Profile saved to browser storage."
                });
                setShowModal(true);
            };

            const loadProfile = () => {
                const saved = localStorage.getItem("trkey_profile"); // Generic key
                if (saved) {
                    const profileData = JSON.parse(saved);
                    // Check for keymap structure compatibility, default if mismatch
                    if (profileData.keymap && Array.isArray(profileData.keymap) && profileData.keymap.length === initialMultiLayerGrid.length) {
                        setKeymap(profileData.keymap);
                    } else {
                        setKeymap(initialMultiLayerGrid);
                        console.warn("Loaded keymap structure mismatch, resetting to initial multi-layer grid.");
                    }
                    setPotentiometerConfig(profileData.potentiometerConfig || { enabled: false, pin: 26, function: 'volume', customAction: '' });
                    setMacros(profileData.macros || []);
                    setModalContent({
                        title: "Profile Loaded",
                        message: "Profile loaded successfully."
                    });
                } else {
                    setModalContent({
                        title: "No Profile Found",
                        message: "No saved profile found."
                    });
                }
                setShowModal(true);
            };

            // Get the full configuration object for export/upload
            const getFullConfig = () => {
                const layersForExport = [];

                keymap.forEach((layerData, lIdx) => {
                    const layerName = `Layer ${lIdx}`;
                    const keys = layerData.flat().map(cell => cell.tap ? cell.tap.combo : "");
                    const labels = layerData.flat().map(cell => cell.tap ? getShortLabel(cell.tap.description) : "");

                    layersForExport.push({
                        name: layerName,
                        labels: labels,
                        keys: keys
                    });
                });

                const fullExportData = {
                    layers: layersForExport,
                    macros: macros.map(m => ({ name: m.name, sequence: m.sequence })),
                    potentiometer: potentiometerConfig
                };
                return fullExportData;
            };

            // Export function updated for general config.json format
            const exportKeymap = () => {
                const fullExportData = getFullConfig();
                const blob = new Blob([JSON.stringify(fullExportData, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "config.json"; // Changed filename to a more general config.json
                a.click();
                setModalContent({
                    title: "Export Successful",
                    message: "Configuration exported as config.json."
                });
                setShowModal(true);
            };


            // JSON Import updated to parse general config.json format
            const loadJsonFromTextArea = () => {
                try {
                    const parsedJson = JSON.parse(jsonInput);

                    if (parsedJson.layers && Array.isArray(parsedJson.layers)) {
                        const newKeymap = Array(NUM_LAYERS).fill().map(() =>
                            Array(3).fill().map(() => Array(3).fill({ tap: null, hold: null }))
                        );
                        let loadedMacros = [];

                        parsedJson.layers.forEach((layerData, lIdx) => {
                            if (lIdx < NUM_LAYERS) {
                                if (layerData.keys && Array.isArray(layerData.keys) && layerData.keys.length === 9) {
                                    layerData.keys.forEach((combo, keyIndex) => {
                                        const rIdx = Math.floor(keyIndex / 3);
                                        const cIdx = keyIndex % 3;
                                        // Use label from JSON if available, otherwise just the combo
                                        const description = layerData.labels && layerData.labels[keyIndex] ? layerData.labels[keyIndex] : combo;

                                        newKeymap[lIdx][rIdx][cIdx] = {
                                            tap: combo ? { combo: combo, description: description } : null,
                                            hold: null
                                        };
                                    });
                                }
                            }
                        });

                        // Load global macros if present
                        if (parsedJson.macros && Array.isArray(parsedJson.macros)) {
                            loadedMacros = parsedJson.macros.map((m, idx) => ({ id: nextMacroId + idx, name: m.name, sequence: m.sequence }));
                        }
                        setKeymap(newKeymap);
                        setMacros(loadedMacros);
                        setNextMacroId(nextMacroId + loadedMacros.length);

                        // Load potentiometer config if present
                        if (parsedJson.potentiometer) {
                            setPotentiometerConfig(parsedJson.potentiometer);
                        } else {
                            // Reset to default if not found
                            setPotentiometerConfig({ enabled: false, pin: 26, function: 'volume', customAction: '' });
                        }

                        setModalContent({
                            title: "JSON Loaded",
                            message: "Configuration loaded from text area successfully."
                        });
                    } else {
                        setModalContent({
                            title: "Invalid JSON",
                            message: "The pasted JSON does not contain a valid configuration structure (expected 'layers' array)."
                        });
                    }
                } catch (error) {
                    setModalContent({
                        title: "JSON Parsing Error",
                        message: "Failed to parse JSON: " + error.message
                    });
                } finally {
                    setShowModal(true);
                }
            };

            // Macro functions
            const addMacro = () => {
                const name = prompt("Enter macro name:");
                if (!name) return;
                const sequence = prompt("Enter macro sequence (e.g., 'Hello World!'):");
                if (sequence) {
                    setMacros(prev => [...prev, { id: nextMacroId, name, sequence }]);
                    setNextMacroId(prev => prev + 1);
                }
            };

            const editMacro = (id) => {
                const macroToEdit = macros.find(m => m.id === id);
                if (!macroToEdit) return;

                const newName = prompt(`Edit name for "${macroToEdit.name}":`, macroToEdit.name);
                if (newName === null) return;

                const newSequence = prompt(`Edit sequence for "${macroToEdit.name}":`, macroToEdit.sequence);
                if (newSequence === null) return;

                setMacros(prev => prev.map(m =>
                    m.id === id ? { ...m, name: newName, sequence: newSequence } : m
                ));
            };

            const deleteMacro = (id) => {
                setModalContent({
                    title: "Confirm Delete",
                    message: "Are you sure you want to delete this macro?",
                    onConfirm: () => {
                        setMacros(prev => prev.filter(m => m.id !== id));
                        setShowModal(false);
                    },
                    onCancel: () => setShowModal(false)
                });
                setShowModal(true);
            };

            return (
                <div className="min-h-screen bg-zinc-800 text-white flex font-inter">
                    {/* Sidebar */}
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />

                    {/* Main Content Area */}
                    <div className="flex-1 flex flex-col p-8 overflow-auto">

                        {activeTab === 'keymap' && (
                            <>
                                <h1 className="text-4xl font-extrabold text-red-400 mb-4">KEYMAP CONFIGURATION</h1>
                                <h2 className="text-2xl font-bold text-zinc-300 mb-8">Currently Viewing: Layer {currentLayer}</h2>
                                <KeymapGrid
                                    keymap={keymap}
                                    handleDrop={handleDrop}
                                    handleKeymapDragStart={handleKeymapDragStart}
                                    handleDragEnd={handleDragEnd}
                                    clearKeymapCell={clearKeymapCell}
                                    currentLayer={currentLayer}
                                    setCurrentLayer={setCurrentLayer}
                                    selectedKeymapCell={selectedKeymapCell}
                                    handleKeymapCellClick={handleKeymapCellClick}
                                />
                                <h2 className="text-3xl font-bold text-red-400 mb-6">SHORTCUTS</h2>
                                <ShortcutPool
                                    shortcutPool={shortcutPool}
                                    draggedShortcut={draggedShortcut}
                                    handleShortcutDragStart={handleShortcutDragStart}
                                    handleDragEnd={handleDragEnd}
                                    selectedKeymapCell={selectedKeymapCell}
                                    handleShortcutClick={handleShortcutClick}
                                />
                            </>
                        )}

                        {activeTab === 'macros' && (
                            <MacroManagement
                                macros={macros}
                                addMacro={addMacro}
                                editMacro={editMacro}
                                deleteMacro={deleteMacro}
                            />
                        )}

                        {activeTab === 'controls' && (
                            <PeripheralControls
                                potentiometerConfig={potentiometerConfig}
                                setPotentiometerConfig={setPotentiometerConfig}
                            />
                        )}

                        {activeTab === 'save-load' && (
                            <SaveLoad
                                saveProfile={saveProfile}
                                loadProfile={loadProfile}
                                exportKeymap={exportKeymap}
                                getFullConfig={getFullConfig} // Pass the getter function
                            />
                        )}

                        {activeTab === 'settings' && (
                            <Settings
                                jsonInput={jsonInput}
                                setJsonInput={setJsonInput}
                                loadJsonFromTextArea={loadJsonFromTextArea}
                            />
                        )}

                        {activeTab === 'keytester' && (
                            <KeyTester activeTab={activeTab} />
                        )}
                    </div>

                    {/* Modals */}
                    <Modal
                        show={showModal && !modalContent.onConfirm}
                        title={modalContent.title}
                        message={modalContent.message}
                        onClose={() => setShowModal(false)}
                    />
                    <ConfirmationModal
                        show={showModal && modalContent.onConfirm}
                        title={modalContent.title}
                        message={modalContent.message}
                        onConfirm={modalContent.onConfirm}
                        onCancel={() => setShowModal(false)}
                    />
                </div>
            );
        }

        // Render the App component into the 'root' div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
